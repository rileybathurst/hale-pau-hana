---
import Layout from "../layouts/Layout.astro";
import fetchApi from "../lib/strapi";
import { BlocksRenderer } from "@strapi/blocks-react-renderer";
import type RateTypes from "../interfaces/rate-types";

// TODO: move a bunch of this overlap with index to a shared file
const rate = await fetchApi<RateTypes>({
  endpoint: "rate",
  wrappedByKey: "data",
  populate: {
    taxId: { populate: true },
    vrbo: {
      populate: true,
    },
    cleaning: {
      populate: true,
    },
    direct: {
      populate: true,
    },
    checkin: {
      populate: true,
    },
    checkout: {
      populate: true,
    },
    taxRate: {
      populate: true,
    },
    rates: {
      populate: true,
    },
    peak_season_start: {
      populate: true,
    },
    peak_season_end: {
      populate: true,
    },
    peak_rate: {
      populate: true,
    },
    off_season_rate: {
      populate: true,
    },
  },
});

const peak_season_start = new Date(rate.attributes.peak_season_start);

const peak_season_end = new Date(rate.attributes.peak_season_end);
// console.log(peak_season_end);

const off_season_start = new Date(rate.attributes.peak_season_start);
off_season_start.setDate(off_season_start.getDate() - 1);
// console.log(off_season_start);

const off_season_end = new Date(rate.attributes.peak_season_end);
off_season_end.setDate(off_season_end.getDate() + 1);
---

<Layout title="Rates">
  <main>
    <hr />
    <h2 class="font-hand">Rates</h2>
    <p>
      If you want to reserve a date or have comments or questions, please email
      or call
    </p>

    <!-- waiting on temporal -->
    <h3>Off Season</h3>
    <section class="season">
      <div class="cal-date">
        <span class="month">
          {off_season_end.toUTCString().split(" ")[2]}
        </span>
        <span>
          {new Date(off_season_end).getUTCDate()}
        </span>
      </div>
      through
      <div class="cal-date">
        <span class="month">
          {off_season_start.toUTCString().split(" ")[2]}
        </span>
        <span>{new Date(off_season_start).getUTCDate()}</span>
      </div>

      ${rate.attributes.off_season_rate}
    </section>

    <hr />
    <h3>Peak Season</h3>
    <section class="season">
      <div class="cal-date">
        <span class="month">
          {peak_season_start.toUTCString().split(" ")[2]}
        </span>
        <span>
          {new Date(rate.attributes.peak_season_start).getUTCDate()}
        </span>
      </div>
      through
      <div class="cal-date">
        <span class="month">
          {peak_season_end.toUTCString().split(" ")[2]}
        </span>
        <span>
          {new Date(rate.attributes.peak_season_end).getUTCDate()}
        </span>
      </div>
      ${rate.attributes.peak_rate}
    </section>
    <hr />

    <BlocksRenderer content={rate.attributes.direct} />
    <p>Hawaii Hotel & excise Tax is %{rate.attributes.taxRate} additional</p>
    <hr />
    <h3>Cleaning</h3>
    <BlocksRenderer content={rate.attributes.cleaning} />
    <hr />
    <h3>Avaliablity</h3>
    <p>
      <a
        href={`www.VRBO.com/${rate.attributes.vrbo}`}
        class="button"
        target="_blank"
        rel="noopener noreferrer"
      >
        VRBO - {rate.attributes.vrbo}
      </a>
    </p>
    <p>
      <a
        href="https://docs.google.com/spreadsheets/d/1ACJAro0VvyIFJ-pVkg10v1InZZX4FY0yavQSbAJ5feI/edit?usp=sharing"
        class="button"
        target="_blank"
        rel="noopener noreferrer"
      >
        Google Sheet
      </a>
    </p>
    <hr />
  </main>
</Layout>
