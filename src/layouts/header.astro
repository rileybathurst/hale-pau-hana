---
import fetchApi from "../lib/strapi";
import SmallMenu from "../components/SmallMenu";
import { BlocksRenderer } from "@strapi/blocks-react-renderer";
import type TextTypes from "../interfaces/text-types";
import type AddressTypes from "../interfaces/address-types";
import type ContactTypes from "../interfaces/contact-types";
import FormatPhoneNumber from "../components/FormatPhoneNumber";

const contact = await fetchApi<ContactTypes>({
  endpoint: "contact",
  wrappedByKey: "data",
  populate: {
    name: {
      populate: true,
    },
    email: {
      populate: true,
    },
    phone: {
      populate: true,
    },
    postal: {
      populate: true,
    },
  },
});

const about = await fetchApi<TextTypes>({
  endpoint: "about",
  wrappedByKey: "data",
  populate: {
    text: {
      populate: true,
    },
  },
});

const address = await fetchApi<AddressTypes>({
  endpoint: "address",
  wrappedByKey: "data",
  populate: {
    streetAddress: {
      populate: true,
    },
    addressLocality: {
      populate: true,
    },
    addressRegion: {
      populate: true,
    },
    addressCountry: {
      populate: true,
    },
    postalCode: {
      populate: true,
    },
    unit: {
      populate: true,
    },
    island: {
      populate: true,
    },
    building: {
      populate: true,
    },
    googleMapLink: {
      populate: true,
    },
  },
});

const pathname = new URL(Astro.request.url).pathname;
const currentPath = pathname.slice(1); // remove the first "/"

// this might need to be reactlive thing
console.log(currentPath);
console.log(Astro.url);
console.log("ðŸ¦„");

// console.log(about);
---

<header class="header">
  <h1 class="font-hand text-center">
    <a href="/" class="link-subtle">
      {address.attributes.building}
    </a>
  </h1>
  {
    about?.attributes.text ? (
      <div class="kilimanjaro-p text-center">
        <BlocksRenderer content={about?.attributes.text} />
      </div>
    ) : null
  }
  <hr />
  <p class="text-center">
    <a
      href={`mailto:${contact.attributes.email}?subject=${address.attributes.building}`}
      class="button"
    >
      {contact.attributes.email}
    </a>
    <a href={`tel:${contact.attributes.phone}`} class="button">
      <FormatPhoneNumber phoneNumberString={contact.attributes.phone} />
    </a>
  </p>

  <hr />

  <SmallMenu client:load />

  <nav class="big-boy">
    <ul>
      <li>
        <a
          href="/directions"
          class={currentPath === "directions" ? "active" : null}
        >
          Directions
        </a>
      </li>
      <li>
        <a
          href="/information"
          class={currentPath === "information" ? "active" : null}
        >
          Information
        </a>
      </li>
      <li>
        <a href="/see-and-do"> Activities </a>
      </li>
      <li>
        <a
          href="/departure"
          class={currentPath === "departure" ? "active" : null}
        >
          Departure
          {
            Astro.url.pathname.slice(1).slice(0, -1) === "departure"
              ? "ðŸ›«"
              : null
          }
        </a>
      </li>
      <li>
        <a href="/rates" class={currentPath === "rates" ? "active" : null}>
          Rates
        </a>
      </li>
    </ul>
  </nav>

  <hr />
  <address class="elbrus text-center">
    <a
      href={address.attributes.googleMapLink}
      target="_blank"
      rel="noopener noreferrer"
    >
      {address.attributes.streetAddress}
      <br />
      {address.attributes.addressLocality},
      {address.attributes.island} - {
        address.attributes.addressRegion == "HI"
          ? "Hawaii"
          : address.attributes.addressRegion
      }
    </a>
  </address>
</header>
